---
title: "Mini-Project #03: Visualizing and Maintaining the Green Canopy of NYC"
author: Hajara Muzammal
format: 
  html:
    code-fold: true
    code-summary: "Show code"
    toc: true
    toc-depth: 3
    theme: cosmo
    embed-resources: true
    results: hide
execute:
  warning: false
  message: false
editor: 
  markdown: 
    wrap: 72
---

# Introduction

New York City's Department of Parks and Recreation manages nearly
900,000 trees across all five boroughs, providing critical environmental
benefits to millions of residents, yet access to this green
infrastructure remains unequal across neighborhoods. This project
analyzes the NYC TreeMap dataset alongside City Council District
boundaries to explore patterns in tree distribution, health, and species
diversity at the district level. Using spatial analysis and data
visualization, we identify opportunities for targeted intervention and
propose a data-driven tree revitalization program that addresses gaps in
the urban canopy and promotes environmental equity.

Data Preparation

```{r}
# Load required packages
library(tidyverse)
library(sf)
library(httr2)
```

# Task 1: Download NYC City Council District Boundaries

```{r}
suppressPackageStartupMessages({
  library(sf)
  library(fs)
})

NYC_City_Council <- function(url){
  mp03 <- file.path("data", "mp03")
  if (!dir.exists(mp03)) {
    dir.create(mp03, showWarnings=FALSE, recursive=TRUE)
  }
  
  zip_path <- file.path(mp03, "NYC City Council District Boundaries.zip")
  if (!file.exists(zip_path)) {
    download.file(url,
                  destfile = zip_path,
                  mode = "wb")
  }
  
  shp_file <- dir_ls(mp03, recurse = TRUE, glob = "*.shp")
  if (length(shp_file) == 0) {
    unzip(zip_path, exdir = mp03)
    shp_file <- dir_ls(mp03, recurse = TRUE, glob = "*.shp")
  }
  
  NYC_file <- st_read(shp_file[1], quiet = TRUE)
  NYC_file <- st_transform(NYC_file, crs = "WGS84")
  
  return(NYC_file)
}

council <- NYC_City_Council("https://s-media.nyc.gov/agencies/dcp/assets/files/zip/data-tools/bytes/city-council/nycc_25c.zip")
```

# Task 2: Download Tree Points

```{r}
library(httr2)
library(sf)
library(dplyr)
library(purrr)
library(jsonlite)

download_tree_points <- function(limit = 50000) {
  # Create folder if needed
  dir.create("data/mp03", showWarnings = FALSE, recursive = TRUE)
  
  # Correct NYC Tree Census API - use JSON not GeoJSON
  base_url <- "https://data.cityofnewyork.us/resource/nwxe-4ae8.json"
  
  offset <- 0
  all_data <- list()
  
  repeat {
    message(paste("Downloading records", offset, "to", offset + limit, "..."))
    
    req <- request(base_url) |>
      req_url_query(`$limit` = limit, `$offset` = offset)
    
    resp <- req_perform(req)
    data_chunk <- resp_body_json(resp, simplifyVector = TRUE)
    
    # Stop if no more data
    if (nrow(data_chunk) == 0) break
    
    all_data[[length(all_data) + 1]] <- data_chunk
    
    # Stop if fewer than limit rows
    if (nrow(data_chunk) < limit) break
    
    offset <- offset + limit
  }
  
  # Combine all chunks
  message("Combining all downloaded data...")
  tree_data <- bind_rows(all_data)
  
  message(paste("Total trees loaded:", nrow(tree_data)))
  
  return(tree_data)
}

# Download the data
trees_raw <- download_tree_points(limit = 50000)

# Convert to sf object with proper geometry
trees_sf <- trees_raw %>%
  filter(!is.na(latitude) & !is.na(longitude)) %>%
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326) %>%
  st_transform(crs = "WGS84")

# Verify it worked
cat("Trees downloaded:", nrow(trees_sf), "\n")
cat("Geometry type:", paste(unique(st_geometry_type(trees_sf)), collapse=", "), "\n")
glimpse(trees_sf)
```

# Task 3: Plot All Tree Points

## Data Integration and Initial Exploration

```{r}
## TASK 3: PLOT ALL TREE POINTS 

#| message: false
#| warning: false

library(ggplot2)
library(dplyr)
library(sf)

plot_trees <- function(tree_data, council_data, n_trees = 10000) {
  # Ensure both are in same CRS
  council_simplified <- council_data %>% 
    st_transform(crs = "WGS84") %>%
    mutate(geometry = st_simplify(geometry, dTolerance = 5))
  
  tree_data <- st_transform(tree_data, crs = "WGS84")
  
  # Sample trees
  if (n_trees < nrow(tree_data)) {
    set.seed(123)
    trees_sample <- tree_data %>% slice_sample(n = n_trees)
  } else {
    trees_sample <- tree_data
  }
  
  ggplot() +
    geom_sf(data = council_simplified, 
            fill = "white", 
            color = "gray20", 
            linewidth = 0.3) +
    geom_sf(data = trees_sample,
            color = "forestgreen", 
            alpha = 0.3, 
            size = 0.8) +
    labs(
      title = paste("NYC Tree Map (", format(n_trees, big.mark=","), " Trees)", sep=""),
      subtitle = "Overlay on City Council Districts",
      caption = "Data: NYC OpenData & NYC Planning"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(size = 12),
      panel.background = element_rect(fill = "white"),
      panel.grid = element_line(color = "gray95")
    )
}
  
```

```{r}
plot_trees(trees_sf, council, n_trees = 5000)

```

Above is a visual of the NYC Council Districts.

## Extra credit 1 - Visualization 

```{r}
# First, check if have the required objects
cat("Checking required objects:\n")
cat("trees exists:", exists("trees"), "\n")
cat("council_districts exists:", exists("council_districts"), "\n")

# If trees doesn't exist, reload it
if (!exists("trees")) {
  trees <- download_tree_points(limit = 5000, pause = 1)
}

# If council_districts doesn't exist, reload it
if (!exists("council_districts")) {
  council_districts <- download_council_districts()
}

# Now run the leaflet code
library(leaflet)
library(htmlwidgets)
library(sf)

# Create interactive map using leaflet
# Sample trees for performance (10,000 points)
set.seed(123)

trees_sample <- trees %>%
  slice_sample(n = 10000) %>%
  mutate(
    species_info = paste0("<b>", genusspecies, "</b><br>",
                          "Condition: ", tpcondition)
  )

# Extract coordinates for leaflet
tree_coords <- st_coordinates(trees_sample)
trees_sample$lon <- tree_coords[, "X"]
trees_sample$lat <- tree_coords[, "Y"]

# Create leaflet map
interactive_map <- leaflet(width = "100%", height = "600px") %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  
  # Add council district boundaries
  addPolygons(
    data = council_districts %>% st_transform(crs = 4326),
    fillColor = "transparent",
    color = "black",
    weight = 2,
    opacity = 0.7,
    label = ~paste("Council District", coun_dist),
    group = "Districts"
  ) %>%
  
  # Add tree points
  addCircleMarkers(
    data = trees_sample,
    lng = ~lon,
    lat = ~lat,
    radius = 3,
    color = "darkgreen",
    fillColor = "forestgreen",
    fillOpacity = 0.6,
    stroke = FALSE,
    popup = ~species_info,
    label = ~genusspecies,
    group = "Trees",
    clusterOptions = markerClusterOptions()
  ) %>%
  
  # Add layer controls
  addLayersControl(
    overlayGroups = c("Districts", "Trees"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  
  # Add scale bar
  addScaleBar(position = "bottomleft") %>%
  
  # Set initial view to NYC
  setView(lng = -73.935242, lat = 40.730610, zoom = 11)

interactive_map

```

Use your mouse wheel or pinch gesture to zoom, and click-drag to pan
across the map. Click any tree marker to view detailed information
including species, condition, and location, or simply hover over a
marker for a quick species preview. The layer control panel in the
upper-right corner allows you to toggle district boundaries and tree
markers on or off. For improved performance, trees are automatically
clustered at higher zoom levels‚Äîzoom in to view individual trees.
Double-click anywhere on the map to reset to the default NYC view. The
scale bar in the bottom-left helps estimate distances.

# Task 4: District-Level Analysis of Tree Coverage

1)  Which council district has the most trees?

```{r}
library(knitr)

district_tree_counts <- trees_with_districts %>%
  st_drop_geometry() %>%
  filter(!is.na(coun_dist)) %>%  # Changed to lowercase
  count(coun_dist, name = "tree_count") %>%
  arrange(desc(tree_count))

# Create formatted table for top 10 with row numbers
district_tree_counts %>%
  head(10) %>%
  mutate(Rank = row_number()) %>%
  select(Rank, coun_dist, tree_count) %>%  # Changed to lowercase
  kable(
    col.names = c("Rank", "Council District", "Number of Trees"),
    format.args = list(big.mark = ","),
    caption = "Table 1: Top 10 NYC Council Districts by Tree Count",
    align = c("c", "c", "c")
  )


```

District 51 has the most trees.

2\. Which district has the highest density of trees?

```{r}
library(knitr)

district_density <- trees_with_districts %>%
  st_drop_geometry() %>%
  filter(!is.na(coun_dist)) %>%  # Changed to lowercase
  count(coun_dist, name = "tree_count") %>%
  left_join(council_districts %>%  # Changed from 'council'
              st_drop_geometry() %>% 
              select(coun_dist, shape_area),  # Changed to lowercase
            by = "coun_dist") %>%  # Changed to lowercase
  mutate(tree_density = tree_count / shape_area) %>%  # Changed to lowercase
  arrange(desc(tree_density))

# Formatted table
district_density %>%
  head(10) %>%
  mutate(Rank = row_number()) %>%
  select(Rank, coun_dist, tree_count, tree_density) %>%  # Changed to lowercase
  kable(
    col.names = c("Rank", "Council District", "Number of Trees", "Tree Density"),
    format.args = list(big.mark = ","),
    caption = "Table 2: Top 10 NYC Council Districts by Tree Density",
    align = c("c", "c", "c", "c"),
    digits = c(0, 0, 0, 6)
  )
  
```

District 39 has the highest tree density.

3.  Which district has highest fraction of dead trees?

```{r}
library(knitr)

dead_tree_fraction <- trees_with_districts %>%
  st_drop_geometry() %>%
  filter(!is.na(coun_dist)) %>%  # Changed to lowercase
  group_by(coun_dist) %>%  # Changed to lowercase
  summarise(
    total_trees = n(),
    # Use tpstructure instead of status - "Retired" and "Stump" indicate dead trees
    dead_trees = sum(tpstructure %in% c("Retired", "Stump"), na.rm = TRUE),
    dead_fraction = dead_trees / total_trees,
    .groups = "drop"
  ) %>%
  arrange(desc(dead_fraction))

# Formatted table
dead_tree_fraction %>%
  head(10) %>%
  mutate(
    Rank = row_number(),
    dead_percentage = dead_fraction * 100
  ) %>%
  select(Rank, coun_dist, total_trees, dead_trees, dead_percentage) %>%  # Changed to lowercase
  kable(
    col.names = c("Rank", "Council District", "Total Trees", "Dead Trees", "Dead Tree %"),
    format.args = list(big.mark = ","),
    caption = "Table 3: Top 10 NYC Council Districts by Dead Tree Percentage",
    align = c("c", "c", "c", "c", "c"),
    digits = c(0, 0, 0, 0, 2)
  )
  
```

District 16 has the highest fraction of dead trees.

4.  What is the most common tree species in Manhattan?

```{r}
library(knitr)

# Add borough information based on district ranges
trees_with_borough <- trees_with_districts %>%
  mutate(Borough = case_when(
    coun_dist >= 1 & coun_dist <= 10 ~ "Manhattan",
    coun_dist >= 11 & coun_dist <= 18 ~ "Bronx",
    coun_dist >= 19 & coun_dist <= 32 ~ "Queens",
    coun_dist >= 33 & coun_dist <= 48 ~ "Brooklyn",
    coun_dist >= 49 & coun_dist <= 51 ~ "Staten Island",
    TRUE ~ NA_character_
  ))

manhattan_species <- trees_with_borough %>%
  st_drop_geometry() %>%
  filter(Borough == "Manhattan", !is.na(genusspecies)) %>%
  count(genusspecies, sort = TRUE)

# Formatted table
manhattan_species %>%
  head(10) %>%
  mutate(Rank = row_number()) %>%
  select(Rank, genusspecies, n) %>%
  kable(
    col.names = c("Rank", "Tree Species", "Count"),
    format.args = list(big.mark = ","),
    caption = "Table 4: Top 10 Most Common Tree Species in Manhattan",
    align = c("c", "l", "c")
  )



```

The most common tree species is honeylocust.

5.  What is the species of the tree closest to Baruch‚Äôs campus?

```{r}
library(knitr)

# Create helper function for point creation
new_st_point <- function(lon, lat) {
  st_sfc(st_point(c(lon, lat))) %>%
    st_set_crs("WGS84")
}

# Baruch College coordinates (Lexington Ave & E 24th St)
baruch_point <- new_st_point(-73.9838, 40.7402)

# Calculate distance from each tree to Baruch
trees_with_distance <- trees_sf %>%
  mutate(distance = st_distance(geometry, baruch_point))

# Show TOP 5 closest trees
top_5_closest <- trees_with_distance %>%
  arrange(distance) %>%
  slice(1:5) %>%
  st_drop_geometry() %>%
  select(spc_common, address, distance) %>%
  mutate(distance_m = round(as.numeric(distance), 1)) %>%
  select(spc_common, address, distance_m)

top_5_closest %>%
  kable(
    col.names = c("Tree Species", "Address", "Distance (m)"),
    caption = "Top 5 Trees Closest to Baruch College Campus",
    align = c("l", "l", "c")
  )


```

Sawtooth oak is the closest tree closest to Baruch.

# Task 5: NYC Parks Proposal

I will be analyzing all the data that is needed for this proposal.

```{r}
# ============================================================================
# Task 5: NYC Parks Proposal - District Tree Program
# ============================================================================

library(tidyverse)
library(sf)
library(scales)

# ============================================================================
# STEP 1: Choose Your District
# ============================================================================

# Choose one of these options:
# Option 1: Baruch's district (District 2 - Manhattan)
my_district <- 2

# Option 2: Your district (replace with your district number)
# my_district <- XX

# Get your district data
my_district_boundary <- council_districts |>
  filter(coun_dist == my_district)

# Get trees in your district
my_district_trees <- trees_with_districts |>
  filter(coun_dist == my_district)

```

```{r}
# ============================================================================
# STEP 2: Choose Your Project Focus
# ============================================================================

# Example: Replace Dead/Retired Trees and Stumps
# Count trees by structure type
tree_structure_summary <- my_district_trees |>
  st_drop_geometry() |>
  count(tpstructure, sort = TRUE)

print(tree_structure_summary)

# Count stumps and retired trees
stumps_count <- my_district_trees |>
  st_drop_geometry() |>
  filter(tpstructure %in% c("Stump", "Retired")) |>
  nrow()

cat("\nStumps and retired trees in your district:", stumps_count, "\n")
```

```{r}
# ============================================================================
# STEP 3: Quantitative Scope Statement
# ============================================================================

# Calculate project scope
project_scope <- my_district_trees |>
  st_drop_geometry() |>
  summarise(
    total_trees = n(),
    stumps = sum(tpstructure == "Stump", na.rm = TRUE),
    retired = sum(tpstructure == "Retired", na.rm = TRUE),
    poor_condition = sum(tpcondition == "Poor", na.rm = TRUE),
    to_replace = stumps + retired
  )

cat("\nProject Scope:\n")
print(project_scope)
```

```{r}
# ============================================================================
# STEP 4: Zoomed-in Map of Your District
# ============================================================================

# Map showing all trees in your district
map_my_district <- ggplot() +
  # District boundary
  geom_sf(data = my_district_boundary, 
          fill = "lightgray", 
          color = "black", 
          linewidth = 1.5) +
  
  # All trees
  geom_sf(data = my_district_trees,
          aes(color = tpstructure),
          size = 0.5,
          alpha = 0.6) +
  
  scale_color_manual(
    name = "Tree Status",
    values = c("Full" = "darkgreen", 
               "Retired" = "orange", 
               "Stump" = "red")
  ) +
  
  theme_minimal() +
  labs(
    title = paste("Trees in Council District", my_district),
    subtitle = paste(format(nrow(my_district_trees), big.mark = ","), "total trees")
  ) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

print(map_my_district)

# Alternative: Map showing only stumps and retired trees
map_replacement_targets <- ggplot() +
  geom_sf(data = my_district_boundary, 
          fill = "white", 
          color = "black", 
          linewidth = 1.5) +
  
  # Only stumps and retired trees
  geom_sf(data = my_district_trees |> 
            filter(tpstructure %in% c("Stump", "Retired")),
          aes(color = tpstructure),
          size = 1,
          alpha = 0.7) +
  
  scale_color_manual(
    name = "Replacement Needed",
    values = c("Retired" = "orange", "Stump" = "red")
  ) +
  
  theme_minimal() +
  labs(
    title = paste("Trees to Replace in District", my_district),
    subtitle = paste(stumps_count, "stumps and retired trees")
  ) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

print(map_replacement_targets)
```

```{r}
# ============================================================================
# STEP 5: Compare to Other Districts
# ============================================================================

# Compare stumps/retired trees across districts
district_comparison <- trees_with_districts |>
  st_drop_geometry() |>
  filter(!is.na(coun_dist)) |>
  group_by(coun_dist) |>
  summarise(
    total_trees = n(),
    stumps_retired = sum(tpstructure %in% c("Stump", "Retired"), na.rm = TRUE),
    percent_need_replacement = (stumps_retired / total_trees) * 100,
    .groups = "drop"
  ) |>
  arrange(desc(stumps_retired))

# Get your district's rank
my_district_rank <- district_comparison |>
  mutate(rank = row_number()) |>
  filter(coun_dist == my_district)

cat("\nYour district ranks #", my_district_rank$rank, 
    "in number of stumps/retired trees\n")

# Top 10 districts needing replacement
cat("\nTop 10 Districts Needing Tree Replacement:\n")
print(head(district_comparison, 10))
```

```{r}
# ============================================================================
# STEP 6: Non-Map Graphic (Bar Chart)
# ============================================================================

# Select districts to compare (your district + 3-4 others)
districts_to_compare <- c(my_district, 1, 3, 5)  # Adjust as needed

comparison_data <- district_comparison |>
  filter(coun_dist %in% districts_to_compare) |>
  mutate(
    is_my_district = coun_dist == my_district,
    district_label = paste("District", coun_dist)
  )

# Bar chart comparing stumps/retired trees
bar_chart_comparison <- ggplot(comparison_data, 
                                aes(x = reorder(district_label, -stumps_retired),
                                    y = stumps_retired,
                                    fill = is_my_district)) +
  geom_col() +
  geom_text(aes(label = comma(stumps_retired)), 
            vjust = -0.5, 
            size = 4) +
  scale_fill_manual(
    values = c("TRUE" = "#E74C3C", "FALSE" = "gray70"),
    guide = "none"
  ) +
  theme_minimal() +
  labs(
    title = "Trees Needing Replacement by District",
    subtitle = "Stumps and Retired Trees",
    x = "Council District",
    y = "Number of Trees"
  ) +
  theme(
    plot.title = element_text(face = "bold", size = 14),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

print(bar_chart_comparison)
```

```{r}
# ============================================================================
# STEP 7: Map Comparison with Other Districts
# ============================================================================

# Compare your district with nearby districts
comparison_districts <- c(my_district, 1, 3, 5)  # Adjust as needed

comparison_boundaries <- council_districts |>
  filter(coun_dist %in% comparison_districts)

comparison_trees <- trees_with_districts |>
  filter(coun_dist %in% comparison_districts,
         tpstructure %in% c("Stump", "Retired"))

map_district_comparison <- ggplot() +
  geom_sf(data = comparison_boundaries,
          aes(fill = factor(coun_dist)),
          alpha = 0.3,
          color = "black",
          linewidth = 0.8) +
  
  geom_sf(data = comparison_trees,
          color = "red",
          size = 0.3,
          alpha = 0.5) +
  
  scale_fill_brewer(
    name = "Council District",
    palette = "Set2"
  ) +
  
  theme_minimal() +
  labs(
    title = "Tree Replacement Needs: District Comparison",
    subtitle = "Red points show stumps and retired trees"
  ) +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  )

print(map_district_comparison)
```

```{r}
# ============================================================================
# STEP 8: Summary Statistics for Proposal
# ============================================================================

cat("\n========================================\n")
cat("PROPOSAL SUMMARY STATISTICS\n")
cat("========================================\n\n")

cat("District:", my_district, "\n")
cat("Total trees:", format(project_scope$total_trees, big.mark = ","), "\n")
cat("Stumps:", format(project_scope$stumps, big.mark = ","), "\n")
cat("Retired trees:", format(project_scope$retired, big.mark = ","), "\n")
cat("Trees in poor condition:", format(project_scope$poor_condition, big.mark = ","), "\n")
cat("Total replacement needed:", format(project_scope$to_replace, big.mark = ","), "\n\n")

cat("Comparison with other districts:\n")
comparison_data |>
  arrange(desc(stumps_retired)) |>
  select(coun_dist, stumps_retired, percent_need_replacement) |>
  print()

cat("\n========================================\n")
```

# Proposal :

Tree Replacement Initiative ‚Äî Council District 2 As a Council Member
representing District 2 (Gramercy, Kips Bay, Murray Hill), I propose a
tree replacement program to address our district's critical tree
maintenance needs.

üåø Project: "ReGrow District 2" The Problem: District 2 has 11,563
trees, but 2,691 trees (23.3%) are dead, retired, or stumps‚Äîthe highest
replacement rate among neighboring Manhattan districts. The Solution:
Remove stumps, replace dead trees, and plant new climate-resilient
species

Why District 2? District 2 stands out with 23.3% of trees needing
replacement‚Äîhigher than Districts 1 (22.8%), 3 (21.2%), and 5 (20.5%).
While District 1 has more trees overall, District 2 has the highest
percentage requiring replacement, making it the most urgent priority for
intervention. Our 2,691 trees needing replacement include: 328 dangerous
stumps (tripping hazards) 2,363 retired/dead trees (providing no
environmental benefit)

Project Scope Proposed Actions: Remove 328 dangerous stumps Replace
2,363 retired/dead trees Plant 500 NEW trees in underserved blocks
Maintain 291 trees in poor condition Total Impact: 3,482 tree
interventions Timeline: 18 months Budget: \$1.5M (\$430 per tree)

üó∫Ô∏è Visualizations Map 1: Distribution of 11,563 trees in District 2 by
condition Chart 2: District 2 has highest replacement needs compared to
Districts 1, 3, 5 Map 3: Red points show 2,691 stumps and retired trees
requiring immediate action.

‚úÖ Expected Outcomes Improved air quality and reduced heat island effect
Enhanced public safety by removing 328 hazardous stumps Expanded tree
canopy with 500 new plantings Healthier urban forest serving 150,000+
residents Request: \$1.5M Parks Department allocation for District 2
tree revitalization.
